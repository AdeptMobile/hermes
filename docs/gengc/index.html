<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-gengc">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">The GenGC Garbage Collector | Hermes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://hermesengine.dev/docs/gengc"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="The GenGC Garbage Collector | Hermes"><meta data-rh="true" name="description" content="GenGC used to be the default garbage collector for Hermes, and aims to provide a"><meta data-rh="true" property="og:description" content="GenGC used to be the default garbage collector for Hermes, and aims to provide a"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hermesengine.dev/docs/gengc"><link data-rh="true" rel="alternate" href="https://hermesengine.dev/docs/gengc" hreflang="en"><link data-rh="true" rel="alternate" href="https://hermesengine.dev/docs/gengc" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c0bb9412.css">
<link rel="preload" href="/assets/js/runtime~main.79f494e2.js" as="script">
<link rel="preload" href="/assets/js/main.c24be046.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Hermes</b></a><a class="navbar__item navbar__link" href="/docs/building-and-running">Docs</a><a class="navbar__item navbar__link" href="/playground/">Playground</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/hermes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/building-and-running">Documentation</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/building-and-running">Building and Running</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/emscripten">Building with Emscripten</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cross-compilation">Cross Compilation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language-features">Language Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/intl">Internationalization APIs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/memory-profilers">Memory Profilers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design">Design Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ir">Design of the IR</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/optimizer">Design of the Optimizer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/vm">VM Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/gengc">The GenGC Garbage Collector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hades">The Hades Garbage Collector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modules">Modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/strings">Strings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/regexp">RegExp</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/react-native-integration">Integrations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/coding-standards">Contributing</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Documentation</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">The GenGC Garbage Collector</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>The GenGC Garbage Collector</h1></header><p>GenGC used to be the default garbage collector for Hermes, and aims to provide a
generational garbage collector that returns memory to the OS aggressively and
frequently. The newer GC is called <a href="/docs/hades">Hades</a>, and it has much lower
pause times than GenGC. We recommend most users use Hades instead.</p><p>Throughout this document, we will refer to the <strong>heap</strong>, which in this context
means the memory space where JS objects reside. This is separate from the C and
C++ <code>malloc</code> heap, and in general if this document says &quot;heap&quot; it means the
space for JS objects.</p><h1>Heap Segments</h1><p>The heap is made out of many fixed-size regions of memory known as
<strong>heap segments</strong> (or more briefly as <strong>segments</strong>). Currently these segments
are 4 MiB, but this can be changed with the CMake build configuration variable
<code>-DHERMESVM_HEAP_SEGMENT_SIZE_KB=number</code>. Memory is acquired and released on a
per-segment basis. Segments are allocated using <code>mmap</code> on POSIX systems and
<code>VirtualAlloc</code> on Windows systems. These functions allow virtual memory to be
requested for some space, and allows us to unmap subregions so that alignment
can be guaranteed. This is done in separate regions because we found that a lot
of devices have trouble allocating enough virtual memory upfront to have the
entire heap be contiguous. By allowing it to grow virtual address space usage
with the size of the heap (and shrink as well), it works on a broader set of
devices. We chose 4 MiB as the size of segments because it was small enough to
not exhaust virtual address space, while also being large enough to not have a
lot of overhead in managing the segments.</p><p>Each heap segment is aligned to begin on a pointer address that is a multiple
of its size. For example, if segments are 4 MiB wide, then their start
addresses are aligned on a 4 MiB boundary (the low 22 bits are all 0). This
means for any pointer into the JS heap, you can get the segment start address
with a simple bitwise-and operation. All metadata for the segment is stored at
the front of the segment.</p><p>At the beginning of a segment, there is a small amount of memory reserved for
some metadata about the heap. Specifically, the following things are kept there:</p><ul><li>Segment ID: explained in <a href="#compressed-pointers">Compressed Pointers</a></li><li>CardTable: explained in <a href="#generations">Generations</a></li><li>MarkBitArray: explained in <a href="#mark-phase">Mark Phase</a></li><li>Guard page: a page of memory that is protected from reads and writes to ensure
bugs in the VM or GC don&#x27;t accidentally overwrite metadata.</li></ul><p>The rest of the segment is free space available for JS values to be allocated
into. See
<a target="_blank" href="/assets/files/AlignedHeapSegment-1dcef337f2faf4bdebfd144dad05a139.h"><code>AlignedHeapSegment::Contents</code></a>
for details about the layout of a heap segment.</p><h1>Object Types</h1><p>In order to determine reachability, we need to be able to discover
what objects point to. To do this for the variety of types in Hermes, we
define a system of metadata for each object, associated to its type which is
encoded as a <code>VTable</code>. Metadata is built once for the first Runtime created, and
is then re-used for every subsequent runtime. The metadata describes at what
offsets from the head of an object there are pointers. It also describes for
any array type where the length of the array can be found, so a dynamic number
of pointers can be found. This design allows pointers to be marked without
performing any type checks, branches, or virtual dispatch.</p><p>The <code>VTable *</code> is embedded in the header of everything allocated on the heap.
This is represented by the C++ superclass of all heap objects, called <code>GCCell</code>.
This way, given a pointer to something in the heap, its type (and pointer
metadata) can be found. The type is stored as a <code>CellKind</code> enum. The <code>VTable</code>
also includes function pointers for dynamic dispatch. This is used to implement
type-based dispatch for things like property accesses and function calls.</p><h1>Generations</h1><p>GenGC is so named because it is <strong>generational</strong>, meaning it manages groups of
allocated objects based on their age. Age is determined by how many collections
an object has survived. GenGC has two generations: the <strong>Young Generation</strong> (YG)
and <strong>Old Generation</strong> (OG).
Allocations go initially into YG, and if they survive the first YG collection
cycle, they are promoted to OG. The OG is collected less frequently and over a
larger number of objects. YG is collected frequently because it is assumed that
there are a lot of objects that were allocated but became garbage quickly. This
is known as the
<a href="https://www.memorymanagement.org/glossary/g.html#generational.hypothesis" target="_blank" rel="noopener noreferrer">Generational Hypothesis</a>:
young objects are more likely to die than old objects.</p><p>The young generation of GenGC is a single segment, regardless of the size
of the heap as a whole. Since YG is much smaller than OG, this is also a much
shorter pause to collect YG. Since the YG is also a single segment, it&#x27;s very
fast to check if a pointer is a YG pointer: get the segment start address and
compare to the YG start address. The allocation algorithm is as follows:</p><ul><li>Attempt to allocate into the YG segment by bumping a pointer called the
&quot;level&quot; of the segment up. If the level would go past the end of the segment, it
fails</li><li>If the bump allocation succeeds, the allocation is complete and control
returns to the VM</li><li>If the bump allocation fails, start a YG collection cycle. This will evacuate
the YG into the OG, and leave some empty space.</li><li>Try bump allocation again after the YG collection cycle completes. If it
succeeds, return.</li><li>Else, try to allocate directly into the OG.</li><li>If the OG is full, start a full collection cycle (collect garbage in both the
YG and OG). Once that completes, try allocating directly into OG again.</li><li>If all that fails, that means there&#x27;s not enough space for the allocation,
raise an Out of Memory (OOM) error</li></ul><p>The old generation of GenGC is a list of segments, each of which is created
after an allocation failed in the previous segment. The OG maintains an
allocation context which remembers the most recent active segment, and this is
where promoted YG objects are allocated into. Once the OG has reached its
configured size limit, it will do a full collection, trying to free garbage
inside the OG.</p><p>There are more details on collection cycles in the
<a href="#collection-cycles">Collection Cycles</a> section.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="allocate-directly-into-the-old-geneneration-pre-tenuring">Allocate directly into the Old Geneneration (Pre-Tenuring)<a href="#allocate-directly-into-the-old-geneneration-pre-tenuring" class="hash-link" aria-label="Direct link to Allocate directly into the Old Geneneration (Pre-Tenuring)" title="Direct link to Allocate directly into the Old Geneneration (Pre-Tenuring)">​</a></h2><p>Sometimes there are applications where the generational hypothesis doesn&#x27;t hold
true, or in other words they allocate more objects that are long-lived than
short-lived. This typically occurs during the initialization period of an
application. If this rule applies to your application, you can request this
behavior from Hermes by changing the <code>GCConfig</code> that&#x27;s used at Runtime
construction time:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">hermes</span><span class="token double-colon punctuation" style="color:#657b83">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#657b83">::</span><span class="token plain">GCConfig</span><span class="token double-colon punctuation" style="color:#657b83">::</span><span class="token plain">Builder gcConfigBuilder</span><span class="token punctuation" style="color:#657b83">{</span><span class="token punctuation" style="color:#657b83">}</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">gcConfigBuilder</span><br></span><span class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">    </span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">withAllocInYoung</span><span class="token punctuation" style="color:#657b83">(</span><span class="token boolean" style="color:#ff8b50">false</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">    </span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">withRevertToYGAtTTI</span><span class="token punctuation" style="color:#657b83">(</span><span class="token boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#657b83">::</span><span class="token plain">unique_ptr</span><span class="token operator" style="color:#fc929e">&lt;</span><span class="token plain">jsi</span><span class="token double-colon punctuation" style="color:#657b83">::</span><span class="token plain">Runtime</span><span class="token operator" style="color:#fc929e">&gt;</span><span class="token plain"> runtime </span><span class="token operator" style="color:#fc929e">=</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">makeHermesRuntime</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">    hermes</span><span class="token double-colon punctuation" style="color:#657b83">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#657b83">::</span><span class="token class-name" style="color:#fac863">RuntimeConfig</span><span class="token double-colon punctuation" style="color:#657b83">::</span><span class="token function" style="color:#79b6f2">Builder</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">        </span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">withGCConfig</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain">gcConfigBuilder</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">build</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>AllocInYoung</code> parameter defaults to <code>true</code>, and controls whether
allocations go into YG by default or OG.
The <code>RevertToYGAtTTI</code> parameter defaults to <code>false</code>, and is unused unless
<code>AllocInYoung</code> is true.</p><p>See the full documentation of <a target="_blank" href="/assets/files/GCConfig-53b498730849a073f73683f6eea89e95.h">GCConfig</a> for
more details and other configuration options.</p><h1>Collection Cycles</h1><p>GenGC determines garbage that can be collected in a program based on what is
reachable in the graph of objects. The graph has <strong>roots</strong> that define the
entrypoint to the graph. These are typically things like variables on the
JS call stack. From the roots, the entire graph of objects is traversed by
following each property to another object. Think of it as similar to a
traditional graph search algorithm, although we make many optimizations specific
to the heap structure.</p><p>GenGC has two different types of garbage collection cycles
(abbreviated as &quot;GC&quot;). There is a Young Generation Collection or YG GC, and a
Full Collection or full GC.
A YG GC collects only objects present in the YG, and promotes objects that are
reachable to the OG so they are collected less frequently.
A full GC collects both the OG and YG simultaneously, and determines the
reachability of every object in the heap.</p><p>There are two common concepts across both types of collections:</p><ul><li>Mark: Marking means setting some state related to an object to say that it was
found to be reachable during the traversal of the heap. In GenGC&#x27;s case, this
is often referred to as a &quot;mark bit&quot;</li><li>Sweep: Sweeping means reclaiming unused space so that it can be re-used by the
allocator. This can look very different depending on the generation</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="young-generation-collection">Young Generation Collection<a href="#young-generation-collection" class="hash-link" aria-label="Direct link to Young Generation Collection" title="Direct link to Young Generation Collection">​</a></h2><p>When a YG collection is triggered, it first needs to mark the roots of the
object graph. Because YG collections occur very frequently, we want the set of
roots to be small. To achieve this we ignore any roots that are known to be
only in the OG. When each pointer is discovered for the first time, an
allocation is made in the OG for the same size, the YG object&#x27;s contents are
copied, and a forwarding pointer is left in the header of the YG object pointing
to the new OG object. After that, if we see the same pointer again, we replace
it with the value of the forwarding pointer.</p><p>We also need to consider any OG objects that point into YG as part of the root
set. That is handled by a separate mechanism during JS execution, detailed below
in the section on <a href="#write-barriers">Write Barriers</a>.</p><p>To find all the reachable objects, we take advantage of the linear nature of
OG, and scan linearly from the original end of the allocated region, until
there aren&#x27;t any more promoted objects. Each promoted object is scanned for its
own pointers. This is how all YG objects are discovered. It&#x27;s similar to a
semi-space algorithm where the second space is the OG.</p><p>Once the objects are all moved, any weak references pointing to YG objects are
updated if the object is still alive, and then any finalizers are run by
iterating over a list of finalizers.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="write-barriers">Write Barriers<a href="#write-barriers" class="hash-link" aria-label="Direct link to Write Barriers" title="Direct link to Write Barriers">​</a></h3><p>As part of the root set, we also consider any OG objects that point into YG.
To determine where these exist without iterating over the whole OG, we use a
<strong>write barrier</strong> whenever a pointer value is written to during JS execution.
If it would create an old -&gt; young pointer, we want to mark the source object
as part of the root set of YG.</p><p>The way we do this is by classifying a small region of memory in the OG as a
<strong>card</strong>, currently 512 bytes. We determine the card for a pointer using the
same alignment trick to get the base address of the segment, then use division
to figure out the card index. The <strong>card table</strong> is a list of bytes stored in
the header of the segment, and when we find an object pointing into the YG, we
&quot;dirty&quot; its card by setting the byte value to 1. We don&#x27;t use a bitmap because
the card table is only 8 KiB, and shrinking it further isn&#x27;t worth it.</p><p>During YG collection time, we can quickly scan each card table for the set of
dirtied cards, then we mark all of the objects on that card. We use a separate
<strong>card object table</strong> to find the first object for a card. That table contains
another byte per card, except it is signed. If the sign is positive, it means
&quot;go back that many bytes to find the first object on this card&quot;. If the sign
is negative, it means &quot;go back that many cards and check the table at that
index&quot;. This encoding scheme allows a low memory cost way to jump across very
large objects.</p><p>Note that the way cards are dirtied means there&#x27;s a chance of promoting some
YG objects that aren&#x27;t actually live. This tradeoff is chosen so the cards take
up less memory and can be scanned quickly. Smaller cards are more precise, but
take up more memory and require more scanning.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="full-collection">Full Collection<a href="#full-collection" class="hash-link" aria-label="Direct link to Full Collection" title="Direct link to Full Collection">​</a></h2><p>A full collection is much larger than a YG collection, so it happens less
frequently. It needs to determine the reachability of every object in the heap.
A full collection is triggered when the OG doesn&#x27;t have enough space to satisfy
an allocation from a YG promotion or a direct-to-OG allocation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mark-phase">Mark Phase<a href="#mark-phase" class="hash-link" aria-label="Direct link to Mark Phase" title="Direct link to Mark Phase">​</a></h3><p>The collection begins with a call to <code>markRoots</code>, although this time
additionally marking roots known to only point into the OG, such as the
<code>IdentifierTable</code>. The first time an object is encountered, it sets a bit in the
mark bit array, so future accesses know that it has already been found. Then we
push the newly discovered object on top of a <strong>mark stack</strong>.</p><p>The mark stack is drained by popping off the top object, scanning all of its
pointers, and pushing objects it discovers onto the mark stack.</p><p>There are two changes implemented to prevent the mark stack from growing without
bound:</p><ul><li>If a pointer to an object is discovered that is after the current address, it
isn&#x27;t pushed on the mark stack. Instead, we jump to the next marked bit when
the mark stack is empty. If the pointer is before the current address, it has to
be pushed on the stack because we won&#x27;t go backwards in the heap normally</li><li>If the mark stack overflows a limit, we drop the whole stack and re-scan from
the beginning of the heap. Since many objects have already been marked, this
will go much faster than previous times. It&#x27;s guaranteed to terminate because
in the worst case eventually every object will be marked and there&#x27;s nothing
to collect.</li></ul><p>Once the marking is complete this way, full reachability is known, and sweeping
can begin.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="weak-map-resolution">Weak Map resolution<a href="#weak-map-resolution" class="hash-link" aria-label="Direct link to Weak Map resolution" title="Direct link to Weak Map resolution">​</a></h3><p>However, one problem to be handled are <strong>weak references</strong>, which are pointers
that do not keep what they point to alive. Now that we know reachability, we
know which weak pointers to make null.</p><p>But there&#x27;s a special case of the JS type <code>WeakMap</code> that has to be handled:
the keys are weak, and the values are strong, unless they keep the key itself
alive. This means the values can&#x27;t be marked until the key is determined
reachable through some other means.</p><p>We delay marking any WeakMap key/value pairs until the end of marking. Then for
each WeakMap, and for each key that is reachable in the weak map, we then mark
the value. If marking the value ends up making another WeakMap key reachable,
we then need to mark that. We repeat this for every key that becomes reachable
until there&#x27;s nothing more to mark. At that point we can finally null out keys
that were never found to be reachable.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sweep--compact-phases">Sweep &amp; Compact Phases<a href="#sweep--compact-phases" class="hash-link" aria-label="Direct link to Sweep &amp; Compact Phases" title="Direct link to Sweep &amp; Compact Phases">​</a></h3><p>Now that full reachability has been computed, we know which objects are garbage.
We want to reclaim that memory so that it can be allocated again. To do so, we
will <strong>compact</strong> all live memory down so that there&#x27;s no space between them,
overwriting the space that was used by dead objects.</p><p>To do this, we iterate through every live object in the heap using the mark
bits, and for each one we compute its new address. We place that new address
as a forwarding pointer in the header of the object (displacing the <code>VTable *</code>
to a temporary vector to avoid losing the type information). Once a forwarding
pointer has been determined for everything in the heap, we do a second pass to
fixup pointers within objects to use the forwarded value. Finally, we copy the
memory from the previous location to the new location, overwriting whatever used
to be there.</p><p>The end result of this is that all live memory sits right next to each other in
the heap segments, and all dead memory has now been reclaimed for the allocator.
We use <code>madvise</code> on POSIX systems to tell the operating system that the leftover
memory is now not needed by the program, and it&#x27;s free to be paged out and zero
filled if the OS needs to.</p><p>At this point control returns to the JS engine, typically to finish the
allocation that started the collection.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/hermes/blob/HEAD/website/../doc/GenGC.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2021-04-09T19:00:01.000Z">Apr 9, 2021</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/vm"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">VM Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/hades"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">The Hades Garbage Collector</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#allocate-directly-into-the-old-geneneration-pre-tenuring" class="table-of-contents__link toc-highlight">Allocate directly into the Old Geneneration (Pre-Tenuring)</a></li><li><a href="#young-generation-collection" class="table-of-contents__link toc-highlight">Young Generation Collection</a><ul><li><a href="#write-barriers" class="table-of-contents__link toc-highlight">Write Barriers</a></li></ul></li><li><a href="#full-collection" class="table-of-contents__link toc-highlight">Full Collection</a><ul><li><a href="#mark-phase" class="table-of-contents__link toc-highlight">Mark Phase</a></li><li><a href="#weak-map-resolution" class="table-of-contents__link toc-highlight">Weak Map resolution</a></li><li><a href="#sweep--compact-phases" class="table-of-contents__link toc-highlight">Sweep &amp; Compact Phases</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/language-features">Language Features</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/building-and-running">Building and Running</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/emscripten">Building with Emscripten</a></li></ul></div><div class="col footer__col"><div class="footer__title">Integrations</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://reactnative.dev/docs/hermes" target="_blank" rel="noopener noreferrer" class="footer__link-item">Using with React Native</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/react-native-integration">Using a custom build with React Native</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/HermesEngine" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://github.com/facebook/hermes" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookies<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright © 2023 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.79f494e2.js"></script>
<script src="/assets/js/main.c24be046.js"></script>
</body>
</html>